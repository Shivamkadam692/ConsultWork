<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Worker Map' %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        #map {
            height: calc(100vh - 200px);
            width: 100%;
            border-radius: 8px;
        }
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .worker-info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar') %>
    <main>
        <div class="container-fluid px-0">
            <div class="position-relative">
                <div id="map"></div>
                <div class="map-controls">
                    <button class="btn btn-sm btn-primary mb-2" id="locateBtn">
                        <i class="bi bi-geo-alt"></i> My Location
                    </button>
                    <br>
                    <button class="btn btn-sm btn-secondary" id="refreshBtn">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="worker-info-panel" id="workerInfoPanel" style="display: none;">
                    <h6 id="selectedWorkerName"></h6>
                    <p class="mb-2" id="selectedWorkerDetails"></p>
                    <a href="#" id="selectedWorkerLink" class="btn btn-primary btn-sm">View Profile</a>
                </div>
            </div>
        </div>
    </main>
    <%- include('../partials/footer') %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="/js/main.js"></script>
    <script>
        let map;
        let markers = [];
        let userMarker = null;
        let userLocation = null;

        // Workers data - this would come from an API endpoint
        const workersData = [];

        function initMap() {
            const defaultLat = 40.7128;
            const defaultLng = -74.0060;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        createMap(userLocation.lat, userLocation.lng);
                    },
                    () => {
                        createMap(defaultLat, defaultLng);
                    }
                );
            } else {
                createMap(defaultLat, defaultLng);
            }
        }

        function createMap(centerLat, centerLng) {
            map = L.map('map').setView([centerLat, centerLng], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            if (userLocation) {
                userMarker = L.marker([userLocation.lat, userLocation.lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map)
                .bindPopup('<b>Your Location</b>').openPopup();
            }

            // Load workers from API
            loadWorkers();
        }

        function loadWorkers() {
            // Get user location for nearby search
            let url = '/public/api/workers/map';
            if (userLocation) {
                url += `?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=50`;
            }

            // Fetch workers from API
            fetch(url)
                .then(response => response.json())
                .then(workers => {
                    if (workers.success === false) {
                        console.error('Error:', workers.message);
                        return;
                    }

                    workers.forEach(worker => {
                        if (worker.lat && worker.lng) {
                            addWorkerMarker(worker);
                        }
                    });

                    if (markers.length > 0) {
                        const group = new L.featureGroup(markers);
                        if (userMarker) {
                            group.addLayer(userMarker);
                        }
                        map.fitBounds(group.getBounds().pad(0.1));
                    } else {
                        // If no workers found, show message
                        L.popup()
                            .setLatLng([map.getCenter().lat, map.getCenter().lng])
                            .setContent('<p>No workers found in this area.</p>')
                            .openOn(map);
                    }
                })
                .catch(error => {
                    console.error('Error loading workers:', error);
                });
        }

        function addWorkerMarker(worker) {
            const customIcon = L.divIcon({
                className: 'custom-worker-marker',
                html: `<div style="background-color: #007bff; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                        <span>${worker.rating ? worker.rating.toFixed(1) : 'N/A'}</span>
                      </div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });

            const marker = L.marker([worker.lat, worker.lng], { icon: customIcon })
                .addTo(map)
                .bindPopup(`
                    <div style="min-width: 200px;">
                        <h6 style="margin: 0 0 5px 0;">${worker.name}</h6>
                        <p style="margin: 0 0 5px 0; color: #666;">
                            <i class="bi bi-star-fill" style="color: #ffc107;"></i> ${worker.rating ? worker.rating.toFixed(1) : 'N/A'} Rating
                        </p>
                        <p style="margin: 0 0 5px 0; color: #666;">
                            <i class="bi bi-geo-alt"></i> ${worker.city || 'N/A'}
                        </p>
                        <p style="margin: 0 0 10px 0; color: #666;">
                            <strong>$${worker.rate || 'N/A'}</strong>/hour
                        </p>
                        <a href="/client/worker/${worker.id}" class="btn btn-primary btn-sm" style="width: 100%;">
                            View Profile
                        </a>
                    </div>
                `);

            marker.on('click', function() {
                map.setView([worker.lat, worker.lng], 15);
                showWorkerInfo(worker);
            });

            markers.push(marker);
        }

        function showWorkerInfo(worker) {
            const panel = document.getElementById('workerInfoPanel');
            document.getElementById('selectedWorkerName').textContent = worker.name;
            document.getElementById('selectedWorkerDetails').innerHTML = `
                <i class="bi bi-star-fill text-warning"></i> ${worker.rating ? worker.rating.toFixed(1) : 'N/A'} | 
                <i class="bi bi-geo-alt"></i> ${worker.city || 'N/A'} | 
                <strong>$${worker.rate || 'N/A'}</strong>/hour
            `;
            document.getElementById('selectedWorkerLink').href = `/client/worker/${worker.id}`;
            panel.style.display = 'block';
        }

        document.getElementById('locateBtn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        if (userMarker) {
                            userMarker.setLatLng([lat, lng]);
                        } else {
                            userMarker = L.marker([lat, lng], {
                                icon: L.icon({
                                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                                    iconSize: [25, 41],
                                    iconAnchor: [12, 41],
                                    popupAnchor: [1, -34],
                                    shadowSize: [41, 41]
                                })
                            }).addTo(map)
                            .bindPopup('<b>Your Location</b>').openPopup();
                        }
                        
                        map.setView([lat, lng], 15);
                    },
                    () => {
                        alert('Unable to get your location. Please enable location services.');
                    }
                );
            }
        });

        document.getElementById('refreshBtn').addEventListener('click', () => {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            loadWorkers();
        });

        // Initialize map on page load
        initMap();
    </script>
</body>
</html>

