<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        #map-container {
            height: 500px;
            transition: transform 0.5s ease, box-shadow 0.5s ease;
        }
        
        #map {
            height: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.5s ease, box-shadow 0.5s ease, border-radius 0.5s ease;
            background-color: #f0f0f0;
        }
        
        .map-container {
            position: relative;
        }
        
        /* Map controls styling */
        .map-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .map-controls .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .map-controls .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }
        
        .view-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
        }
        
        .view-toggle label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #333;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        /* 3D view styles */
        .map-3d-view {
            transform: perspective(1200px) rotateX(15deg) translateZ(50px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        .map-3d-view #map {
            border-radius: 12px;
        }
        
        /* Directions panel styles */
        .directions-panel {
            background: white;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .directions-item {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            background: #f8f9fa;
            border-left: 4px solid #3b82f6;
            transition: background 0.2s ease;
        }
        
        .directions-item:hover {
            background: #e9ecef;
        }
        
        .directions-step {
            font-weight: bold;
            margin-right: 0.75rem;
            color: #3b82f6;
            min-width: 24px;
            text-align: center;
        }
        
        .directions-text {
            flex: 1;
        }
        
        .directions-distance {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        .directions-icon {
            margin-right: 0.75rem;
            font-size: 1.2rem;
            color: #3b82f6;
            min-width: 24px;
            text-align: center;
        }
        
        .directions-summary {
            background: #e3f2fd;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        .distance-box {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar') %>
    <main>
        <div class="container my-5">
            <h1 class="mb-4">Search Workers</h1>
            
            <!-- Search Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="GET" action="/client/search">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Skill Category</label>
                                <select class="form-select" name="category">
                                    <option value="">All Skills</option>
                                    <option value="Plumbing" <%= filters.category === 'Plumbing' ? 'selected' : '' %>>Plumbing</option>
                                    <option value="Electrical" <%= filters.category === 'Electrical' ? 'selected' : '' %>>Electrical</option>
                                    <option value="Carpentry" <%= filters.category === 'Carpentry' ? 'selected' : '' %>>Carpentry</option>
                                    <option value="Tutoring" <%= filters.category === 'Tutoring' ? 'selected' : '' %>>Tutoring</option>
                                    <option value="Cleaning" <%= filters.category === 'Cleaning' ? 'selected' : '' %>>Cleaning</option>
                                    <option value="Painting" <%= filters.category === 'Painting' ? 'selected' : '' %>>Painting</option>
                                    <option value="Gardening" <%= filters.category === 'Gardening' ? 'selected' : '' %>>Gardening</option>
                                    <option value="HVAC" <%= filters.category === 'HVAC' ? 'selected' : '' %>>HVAC</option>
                                    <option value="Roofing" <%= filters.category === 'Roofing' ? 'selected' : '' %>>Roofing</option>
                                    <option value="Flooring" <%= filters.category === 'Flooring' ? 'selected' : '' %>>Flooring</option>
                                    <option value="Other" <%= filters.category === 'Other' ? 'selected' : '' %>>Other</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-control" name="location" value="<%= filters.location || '' %>" placeholder="City or Area">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Min Rating</label>
                                <input type="number" class="form-control" name="rating" value="<%= filters.rating || '' %>" min="1" max="5" step="0.1">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Max Budget</label>
                                <input type="number" class="form-control" name="budget" value="<%= filters.budget || '' %>" placeholder="$">
                            </div>
                            <div class="col-md-2 mb-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">Search</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>





            


            <!-- List View -->
            <div id="listView">
                <div class="row">
                    <% if (workers.length > 0) { %>
                        <% workers.forEach(worker => { %>
                            <div class="col-md-4 mb-4 worker-card" 
                                 data-worker-id="<%= worker._id %>"
                                 data-lat="<%= worker.address?.coordinates?.latitude || '' %>"
                                 data-lng="<%= worker.address?.coordinates?.longitude || '' %>"
                                 data-name="<%= worker.firstName %> <%= worker.lastName %>"
                                 data-rating="<%= worker.averageRating %>"
                                 data-city="<%= worker.address?.city || 'N/A' %>"
                                 data-rate="<%= worker.rates?.hourly || 'N/A' %>">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <img src="<%= worker.profileImage || '/images/default-avatar.png' %>" alt="Profile" class="rounded-circle me-3" width="60" height="60">
                                            <div>
                                                <h5 class="mb-0"><%= worker.firstName %> <%= worker.lastName %></h5>
                                                <div class="text-warning">
                                                    <% for (let i = 0; i < 5; i++) { %>
                                                        <i class="bi bi-star<%= i < Math.round(worker.averageRating) ? '-fill' : '' %>" ></i>
                                                    <% } %>
                                                    <span class="text-muted ms-1">(<%= worker.averageRating.toFixed(1) %>)</span>
                                                </div>
                                            </div>
                                        </div>
                                        <p class="text-muted mb-2"><i class="bi bi-geo-alt"></i> 
                                            <% if (worker.address?.city) { %>
                                                <%= worker.address.city %>
                                            <% } else if (worker.serviceAreas && worker.serviceAreas.length > 0) { %>
                                                Serves: 
                                                <% worker.serviceAreas.slice(0, 2).forEach((area, index) => { %>
                                                    <%= area.city %><%= index < worker.serviceAreas.slice(0, 2).length - 1 ? ', ' : '' %>
                                                <% }); %>
                                                <% if (worker.serviceAreas.length > 2) { %>
                                                    (+<%= worker.serviceAreas.length - 2 %> more)
                                                <% } %>
                                            <% } else { %>
                                                Location not specified
                                            <% } %>
                                        </p>
                                        <% if (worker.skills && worker.skills.length > 0) { %>
                                            <p class="mb-2">
                                                <% worker.skills.slice(0, 3).forEach((skill, index) => { %>
                                                    <span class="badge bg-primary me-1"><%= skill.category %></span>
                                                <% }); %>
                                                <% if (worker.skills.length > 3) { %>
                                                    <span class="badge bg-secondary">+<%= worker.skills.length - 3 %> more</span>
                                                <% } %>
                                            </p>
                                        <% } %>
                                        <% if (worker.rates?.hourly) { %>
                                            <p class="mb-2"><strong>$<%= worker.rates.hourly %></strong>/hour</p>
                                        <% } %>
                                        <div class="d-flex gap-2">
                                            <a href="/client/worker/<%= worker._id %>" class="btn btn-primary btn-sm flex-fill">View Profile</a>
                                            <button class="btn btn-success btn-sm" onclick="handleWorkerAction('<%= worker._id %>', 'accept')" title="Accept Worker">
                                                <i class="bi bi-check"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="handleWorkerAction('<%= worker._id %>', 'reject')" title="Reject Worker">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="col-12">
                            <div class="alert alert-info">No workers found. Try adjusting your search filters.</div>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Pagination -->
            <% if (totalPages > 1) { %>
                <nav>
                    <ul class="pagination justify-content-center">
                        <% for (let i = 1; i <= totalPages; i++) { %>
                            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                <a class="page-link" href="?page=<%= i %>&category=<%= filters.category || '' %>&location=<%= filters.location || '' %>"><%= i %></a>
                            </li>
                        <% } %>
                    </ul>
                </nav>
            <% } %>
        </div>
    </main>
    <%- include('../partials/footer') %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="/js/main.js"></script>
    <script>
        // Handle worker accept/reject actions
        function handleWorkerAction(workerId, action) {
            if (action === 'accept') {
                // Handle accept action
                if (confirm('Are you sure you want to accept this worker?')) {
                    // Send request to server
                    fetch(`/worker/client-action/${workerId}/accept`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Worker accepted successfully! A notification has been sent to the client.');
                            // Optionally reload the page or update UI
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while accepting the worker.');
                    });
                }
            } else if (action === 'reject') {
                // Handle reject action
                const reason = prompt('Please provide a reason for rejecting this worker:');
                if (reason !== null) { // User didn't cancel the prompt
                    // Send request to server
                    fetch(`/worker/client-action/${workerId}/reject`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ reason: reason })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`Worker rejected with reason: ${reason}. A notification has been sent to the client.`);
                            // Optionally reload the page or update UI
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while rejecting the worker.');
                    });
                }
            }
        }
    </script>
</body>
</html>

